<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Kitap Ekle</title>
    <style>
        body { font-family: sans-serif; max-width: 400px; margin: 50px auto; padding: 20px; }
        input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #007bff; color: white; cursor: pointer; border: none; font-weight: bold; }
        #durum { padding: 10px; display: none; margin-top: 10px; border-radius: 5px; font-size: 14px; }
    </style>
</head>
<body>
    <h3>üìö Kitap Ekle</h3>
    <input type="text" id="kitapAdi" placeholder="Kitap adƒ± girin...">
    <button id="anaButon" onclick="kitapEkle()">Sisteme Kaydet</button>
    <div id="durum"></div>

    <script>
        // BURAYI KENDƒ∞ Bƒ∞LGƒ∞LERƒ∞NLE DOLDUR
        const TOKEN = "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"; 
        const USER = ugurunal45"; 
        const REPO = "kitapligim";

        async function kitapEkle() {
            const ad = document.getElementById('kitapAdi').value;
            const durum = document.getElementById('durum');
            const buton = document.getElementById('anaButon');

            if(!ad) return alert("L√ºtfen kitap adƒ± yazƒ±n.");

            buton.disabled = true;
            durum.style.display = "block";
            durum.innerText = "‚è≥ ƒ∞≈ülem yapƒ±lƒ±yor, l√ºtfen bekleyin...";
            durum.style.background = "#eee";

            try {
                // 1. Google Books'tan Ara
                const gRes = await fetch(`https://www.googleapis.com/books/v1/volumes?q=intitle:${encodeURIComponent(ad)}`);
                const gData = await gRes.json();
                if(!gData.items) throw new Error("Kitap bulunamadƒ±.");
                
                const k = gData.items[0].volumeInfo;
                const yeniKitap = { 
                    baslik: k.title, 
                    yazar: k.authors ? k.authors[0] : "Bilinmiyor", 
                    yayinevi: k.publisher || "Bilinmiyor" 
                };

                // 2. GitHub'dan mevcut dosyayƒ± al
                const url = `https://api.github.com/repos/${USER}/${REPO}/contents/kitaplar.json`;
                const fRes = await fetch(url, { 
                    headers: { Authorization: `token ${TOKEN}`, "Accept": "application/vnd.github.v3+json" } 
                });
                const fData = await fRes.json();

                // --- HATA √á√ñZ√úM√ú BURADA ---
                let eskiIcerik = [];
                if (fData.content) {
                    try {
                        // √ñnce i√ßeriƒüi temizle ve √ß√∂z
                        const temizIcerik = fData.content.replace(/\s/g, '');
                        eskiIcerik = JSON.parse(decodeURIComponent(escape(window.atob(temizIcerik))));
                    } catch (e) {
                        console.log("Dosya bo≈ü veya bozuk, yeni liste olu≈üturuluyor.");
                        eskiIcerik = [];
                    }
                }
                
                eskiIcerik.push(yeniKitap);

                // 3. GitHub'a Geri G√∂nder
                const yeniB64 = window.btoa(unescape(encodeURIComponent(JSON.stringify(eskiIcerik, null, 2))));
                
                const gonderRes = await fetch(url, {
                    method: "PUT",
                    headers: { Authorization: `token ${TOKEN}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: `Eklendi: ${yeniKitap.baslik}`,
                        content: yeniB64,
                        sha: fData.sha
                    })
                });

                if(gonderRes.ok) {
                    durum.innerText = "‚úÖ Ba≈üarƒ±yla eklendi: " + yeniKitap.baslik;
                    durum.style.background = "#d4edda";
                    document.getElementById('kitapAdi').value = "";
                } else {
                    throw new Error("GitHub kayƒ±t hatasƒ±!");
                }
            } catch (e) {
                durum.innerText = "‚ùå Hata: " + e.message;
                durum.style.background = "#f8d7da";
            } finally {
                buton.disabled = false;
            }
        }
    </script>
</body>
</html>
